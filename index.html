<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Army SMM</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f0c29; color: white; text-align: center; padding: 20px; }
        .card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; max-width: 400px; margin: auto; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; }
        button { background: #00d2ff; color: white; font-weight: bold; cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); padding: 20px; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="card">
            <h2 id="title">تسجيل الدخول / حساب جديد</h2>
            <input type="text" id="name" placeholder="الاسم (عند التسجيل فقط)">
            <input type="email" id="email" placeholder="البريد الإلكتروني">
            <input type="password" id="pass" placeholder="كلمة المرور">
            <button onclick="handleAuth()">دخول / تسجيل</button>
        </div>
    </div>

    <div id="mainDashboard" style="display:none;">
        <div class="card">
            <h3>مرحباً: <span id="userName">...</span></h3>
            <h2>الرصيد: $<span id="userBalance">0.00</span></h2>
            <button onclick="document.getElementById('rechargeModal').style.display='block'" style="background:#28a745;">شحن رصيد</button>
            <hr>
            <select id="srv"><option value="followers">متابعين</option></select>
            <input type="number" id="qty" placeholder="الكمية" oninput="calc()">
            <p>السعر: $<span id="price">0.00</span></p>
            <button onclick="sendOrder()">تأكيد الطلب</button>
            <button onclick="firebase.auth().signOut()" style="background:gray;">خروج</button>
        </div>
    </div>

    <div id="rechargeModal" class="modal">
        <div class="card" style="margin-top: 50px;">
            <h3>طلب شحن</h3>
            <input type="number" id="amt" placeholder="المبلغ">
            <input type="text" id="txCode" placeholder="كود التحويل">
            <button onclick="sendRecharge()">إرسال</button>
            <button onclick="document.getElementById('rechargeModal').style.display='none'" style="background:red;">إلغاء</button>
        </div>
    </div>

    <script>
        // تكوين Firebase
        const config = {
            apiKey: "AIzaSyDrLSVoJJsEzlmcIBvNNb9OJzWtJixYhpw",
            authDomain: "army-smm.firebaseapp.com",
            projectId: "army-smm",
            storageBucket: "army-smm.firebasestorage.app",
            messagingSenderId: "27268417960",
            appId: "1:27268417960:web:990e040e77a0c38a11f59d"
        };
        firebase.initializeApp(config);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 1. وظيفة الدخول والتسجيل
        async function handleAuth() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            const n = document.getElementById('name').value;
            if(!e || !p) return alert("أدخل البيانات");

            try {
                // نحاول تسجيل الدخول أولاً، إذا فشل نقوم بإنشاء حساب
                await auth.signInWithEmailAndPassword(e, p).catch(async (err) => {
                    const res = await auth.createUserWithEmailAndPassword(e, p);
                    await db.collection("users").doc(res.user.uid).set({
                        name: n || "عميل", balance: 0, uid: res.user.uid, accountCode: Math.floor(100000+Math.random()*900000)
                    });
                });
            } catch (error) { alert("خطأ: " + error.message); }
        }

        // 2. مراقبة حالة المستخدم
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    const d = doc.data();
                    document.getElementById('userName').innerText = d.name;
                    document.getElementById('userBalance').innerText = d.balance.toFixed(2);
                });
            } else {
                document.getElementById('authOverlay').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'none';
            }
        });

        // 3. حساب السعر
        function calc() {
            const q = document.getElementById('qty').value;
            document.getElementById('price').innerText = (q * 3 / 1000).toFixed(2);
        }

        // 4. الإرسال للسيرفر
        async function apiCall(data) {
            const user = auth.currentUser;
            const snap = await db.collection("users").doc(user.uid).get();
            const uData = snap.data();

            return fetch('https://army-bot-3y9o.onrender.com/send_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...data,
                    user_uid: user.uid,
                    user_name: uData.name,
                    acc_code: uData.accountCode
                })
            });
        }

        async function sendRecharge() {
            const a = document.getElementById('amt').value;
            const c = document.getElementById('txCode').value;
            if(!a || !c) return alert("أكمل البيانات");
            const res = await apiCall({ type: 'شحن رصيد', details: {"المبلغ": a, "الكود": c} });
            if(res.ok) { alert("تم الإرسال!"); document.getElementById('rechargeModal').style.display='none'; }
        }

        async function sendOrder() {
            const p = document.getElementById('price').innerText;
            const res = await apiCall({ type: 'طلب رشق', details: {"السعر": p} });
            if(res.ok) alert("تم طلب الرشق!");
        }
    </script>
</body>
</html>
