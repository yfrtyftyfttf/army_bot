<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Army SMM - Final Stable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #00d2ff; --secondary: #3a7bd5; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #302b63, #0f0c29); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .dashboard { width: 90%; max-width: 400px; background: var(--glass); backdrop-filter: blur(10px); border-radius: 25px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .balance-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; position: relative; }
        .user-id { position: absolute; top: 5px; right: 10px; font-size: 10px; opacity: 0.8; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: white; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-primary:active { transform: scale(0.95); opacity: 0.8; }
        
        #authOverlay { position: fixed; inset: 0; background: #0a0b0e; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: #161b22; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid var(--primary); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1c23; padding: 20px; border-radius: 15px; width: 80%; border: 1px solid var(--primary); }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-card">
            <h2 id="authTitle">إنشاء حساب</h2>
            <input type="text" id="regName" placeholder="الاسم الكامل">
            <input type="email" id="regEmail" placeholder="البريد الإلكتروني">
            <input type="password" id="regPass" placeholder="كلمة المرور">
            <button id="authBtn" class="btn-primary">دخول / تسجيل</button>
            <p id="toggleAuth" style="color: var(--primary); cursor: pointer; text-align: center; font-size: 13px; margin-top: 15px;">لديك حساب؟ سجل دخول</p>
        </div>
    </div>

    <div class="dashboard">
        <div class="balance-card">
            <div class="user-id">ID: <span id="displayUserCode">000000</span></div>
            <h3 style="margin:0;">مرحباً، <span id="displayUserName">...</span></h3>
            <h1 style="margin: 10px 0;">$<span id="userBalance">0.00</span></h1>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <button onclick="document.getElementById('rechargeModal').style.display='flex'" class="btn-primary" style="background: #28a745;"><i class="fas fa-plus"></i> شحن</button>
            <button onclick="window.open('https://t.me/yfrtyftyfttf')" class="btn-primary" style="background: #17a2b8;"><i class="fas fa-headset"></i> دعم</button>
        </div>

        <div class="order-form">
            <select id="platform">
                <option value="" disabled selected>اختر المنصة</option>
                <option value="instagram">إنستغرام</option>
                <option value="tiktok">تيك توك</option>
                <option value="telegram">تليجرام</option>
            </select>
            <select id="serviceType">
                <option value="followers">متابعين ($3/1k)</option>
                <option value="likes">لايكات ($1/1k)</option>
                <option value="views">مشاهدات ($0.1/1k)</option>
            </select>
            <input type="text" id="targetLink" placeholder="الرابط هنا">
            <input type="number" id="quantity" placeholder="الكمية">
            <div style="text-align: center; margin: 10px 0;">السعر: <span id="totalPrice" style="color: #00ff88;">0.00</span>$</div>
            <button id="orderBtn" class="btn-primary">تأكيد الطلب</button>
        </div>
        <button onclick="firebase.auth().signOut()" style="background:none; border:none; color:gray; width:100%; margin-top:15px; cursor:pointer;">تسجيل الخروج</button>
    </div>

    <div id="rechargeModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align: center;">شحن رصيد</h3>
            <input type="number" id="chargeAmount" placeholder="المبلغ ($)">
            <input type="text" id="transferCode" placeholder="كود التحويل">
            <button id="chargeBtn" class="btn-primary">إرسال للمراجعة</button>
            <button onclick="document.getElementById('rechargeModal').style.display='none'" style="background:none; border:none; color:red; width:100%; margin-top:10px; cursor:pointer;">إلغاء</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrLSVoJJsEzlmcIBvNNb9OJzWtJixYhpw",
            authDomain: "army-smm.firebaseapp.com",
            projectId: "army-smm",
            storageBucket: "army-smm.firebasestorage.app",
            messagingSenderId: "27268417960",
            appId: "1:27268417960:web:990e040e77a0c38a11f59d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let isLoginMode = false;
        let userData = null;

        // --- معالجة الأزرار (طريقة الأمان العالية) ---
        
        // 1. زر الدخول / التسجيل
        document.getElementById('authBtn').addEventListener('click', async () => {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            
            if(!email || !pass) return alert("أكمل البيانات");
            
            try {
                if(isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    const accCode = Math.floor(100000 + Math.random() * 900000);
                    await db.collection("users").doc(res.user.uid).set({
                        name: name || "عميل", email, balance: 0, uid: res.user.uid, accountCode: accCode
                    });
                }
            } catch(e) { alert("خطأ: " + e.message); }
        });

        // 2. زر إرسال الشحن
        document.getElementById('chargeBtn').addEventListener('click', async () => {
            const amt = document.getElementById('chargeAmount').value;
            const code = document.getElementById('transferCode').value;
            if(!amt || !code) return alert("أكمل البيانات");
            
            const btn = document.getElementById('chargeBtn');
            btn.disabled = true;
            
            try {
                const res = await fetch('https://army-bot-3y9o.onrender.com/send_order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'شحن رصيد',
                        user_uid: auth.currentUser.uid,
                        user_name: userData.name,
                        details: {"المبلغ": amt, "الكود": code, "كود_الحساب": userData.accountCode}
                    })
                });
                if(res.ok) {
                    alert("✅ تم الإرسال!");
                    document.getElementById('rechargeModal').style.display = 'none';
                }
            } catch(e) { alert("فشل الاتصال بالسيرفر"); }
            btn.disabled = false;
        });

        // 3. زر تأكيد الطلب
        document.getElementById('orderBtn').addEventListener('click', async () => {
            const price = parseFloat(document.getElementById('totalPrice').innerText);
            if(userData.balance < price) return alert("رصيد غير كافٍ");
            
            const btn = document.getElementById('orderBtn');
            btn.disabled = true;
            
            try {
                const res = await fetch('https://army-bot-3y9o.onrender.com/send_order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'طلب رشق',
                        user_uid: auth.currentUser.uid,
                        user_name: userData.name,
                        details: {
                            "المنصة": document.getElementById('platform').value,
                            "الكمية": document.getElementById('quantity').value,
                            "السعر": price + "$",
                            "كود_الحساب": userData.accountCode
                        }
                    })
                });
                if(res.ok) alert("✅ تم استلام طلبك!");
            } catch(e) { alert("خطأ في الإرسال"); }
            btn.disabled = false;
        });

        // حساب السعر تلقائياً
        document.getElementById('quantity').addEventListener('input', () => {
            const rates = { followers: 3, likes: 1, views: 0.1 };
            const type = document.getElementById('serviceType').value;
            const qty = document.getElementById('quantity').value;
            document.getElementById('totalPrice').innerText = (qty * (rates[type] || 0) / 1000).toFixed(2);
        });

        // مراقبة الدخول
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('authOverlay').style.display = 'none';
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    userData = doc.data();
                    document.getElementById('displayUserName').innerText = userData.name;
                    document.getElementById('userBalance').innerText = userData.balance.toFixed(2);
                    document.getElementById('displayUserCode').innerText = userData.accountCode;
                });
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
            }
        });

        document.getElementById('toggleAuth').onclick = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "تسجيل الدخول" : "إنشاء حساب";
            document.getElementById('regName').style.display = isLoginMode ? "none" : "block";
        };
    </script>
</body>
</html>
