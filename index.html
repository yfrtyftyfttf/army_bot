<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Followers - النظام المتكامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --main: #00d2ff; --bg: #0a0b0e; --card: #161b22; --text: #c9d1d9; --success: #00ff88; --gold: #ffd700; --danger: #ff4d4d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; direction: rtl; overflow-x: hidden; }
        
        /* الهيدر والقائمة */
        .container { max-width: 450px; margin: auto; display: none; padding: 15px; }
        .user-header { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #30363d; margin-bottom: 15px; text-align: center; }
        .user-header h2 { color: var(--main); margin: 5px 0; font-size: 32px; }
        .id-badge { display: inline-block; margin-top: 10px; padding: 5px 15px; background: #0d1117; border-radius: 12px; border: 1px solid #30363d; font-size: 13px; color: #888; cursor: pointer; }

        /* الأقسام */
        .section { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #30363d; margin-bottom: 15px; }
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .action-btn { background: var(--card); padding: 15px 5px; border-radius: 15px; border: 1px solid #30363d; text-align: center; cursor: pointer; font-size: 11px; }
        .action-btn i { display: block; font-size: 22px; margin-bottom: 8px; color: var(--main); }

        /* المدخلات */
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: white; box-sizing: border-box; }
        .btn-main { background: var(--main); color: #000; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .price-box { background: #1f2937; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; color: var(--success); border: 1px dashed var(--success); margin-bottom: 10px; }

        /* لوحة الإدارة */
        #adminPanel { display: none; background: #0d1117; border: 2px solid var(--main); padding: 15px; border-radius: 20px; margin-top: 20px; }
        .admin-item { background: #161b22; padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; font-size: 13px; }
        .admin-proof { width: 100%; max-height: 200px; object-fit: contain; margin: 10px 0; border-radius: 10px; cursor: pointer; }
        .admin-actions { display: flex; gap: 5px; margin-top: 10px; }
        .adm-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }

        /* شاشات الدخول والمودالات */
        .auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; }
    </style>
</head>
<body>

<div id="authScreen" class="auth-screen">
    <div id="loginBox" class="section" style="width: 100%; max-width: 350px; text-align: center;">
        <h2>تسجيل دخول</h2>
        <input type="email" id="logEmail" placeholder="البريد الإلكتروني">
        <input type="password" id="logPass" placeholder="كلمة المرور">
        <button class="btn-main" onclick="handleLogin()">دخول</button>
        <p onclick="toggleAuth(true)" style="margin-top:15px; cursor:pointer;">جديد هنا؟ إنشاء حساب</p>
    </div>
    <div id="signupBox" class="section" style="width: 100%; max-width: 350px; text-align: center; display: none;">
        <h2>إنشاء حساب</h2>
        <input type="text" id="newName" placeholder="الاسم الكامل">
        <input type="email" id="newEmail" placeholder="البريد الإلكتروني">
        <input type="password" id="newPass" placeholder="كلمة المرور">
        <button class="btn-main" onclick="handleSignup()">تسجيل</button>
        <p onclick="toggleAuth(false)" style="margin-top:15px; cursor:pointer;">لديك حساب؟ دخول</p>
    </div>
</div>

<div class="container" id="dashboard">
    <div class="user-header">
        <div id="uNameDisplay">---</div>
        <h2 id="uBalanceDisplay">$0.00</h2>
        <div class="id-badge" onclick="checkAdmin()">ID: <span id="uIDDisplay">---</span> (لوحة الإدارة)</div>
    </div>

    <div class="action-grid">
        <div class="action-btn" onclick="openModal('rechargeModal')"><i class="fas fa-plus-circle"></i> شحن</div>
        <div class="action-btn" onclick="openUserOrders()"><i class="fas fa-list"></i> طلباتي</div>
        <div class="action-btn" onclick="window.location.href='https://t.me/lRAQ97'"><i class="fab fa-telegram-plane"></i> الدعم</div>
        <div class="action-btn" onclick="firebase.auth().signOut()"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </div>

    <div class="section">
        <h4><i class="fas fa-shopping-cart"></i> اطلب خدمة</h4>
        <select id="platform" onchange="updateServices()">
            <option value="تيك توك">تيك توك</option>
            <option value="انستقرام">انستقرام</option>
            <option value="تليجرام">تليجرام</option>
        </select>
        <select id="serviceType" onchange="calcPrice()"></select>
        <input type="url" id="orderLink" placeholder="رابط الحساب">
        <input type="number" id="orderQty" placeholder="الكمية" oninput="calcPrice()">
        <div class="price-box">الإجمالي: <span id="totalPrice">0.00</span>$</div>
        <button class="btn-main" onclick="sendOrder()">تأكيد الطلب</button>
    </div>

    <div id="adminPanel">
        <h3 style="text-align: center; color: var(--main);">لوحة المسؤول</h3>
        <hr color="#333">
        <h4>طلبات شحن (معلقة):</h4>
        <div id="adminRechargeList"></div>
        <h4>طلبات رشق (معلقة):</h4>
        <div id="adminServiceList"></div>
    </div>
</div>

<div id="rechargeModal" class="modal">
    <div class="modal-content">
        <h3>شحن الرصيد</h3>
        <select id="payMethod">
            <option value="ماستر كارد">ماستر كارد (وصل)</option>
            <option value="آسيا سيل">آسيا سيل (كود)</option>
        </select>
        <input type="text" id="payCode" placeholder="الكود أو رقم التحويل">
        <input type="number" id="payAmount" placeholder="المبلغ المتوقع $">
        <label style="font-size: 12px; color: gray;">ارفع الوصل (اختياري للآسيا):</label>
        <input type="file" id="payFile" accept="image/*">
        <button class="btn-main" onclick="submitRechargeRequest()">إرسال الطلب</button>
        <button class="btn-main" style="background: #333; margin-top:5px;" onclick="closeModal('rechargeModal')">إغلاق</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDrLSVoJJsEzlmcIBvNNb9OJzWtJixYhpw",
        authDomain: "army-smm.firebaseapp.com",
        projectId: "army-smm",
        storageBucket: "army-smm.firebasestorage.app",
        messagingSenderId: "27268417960",
        appId: "1:27268417960:web:990e040e77a0c38a11f59d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    const services = {
        "تيك توك": { "متابعين": 0.5, "لايكات": 0.2 },
        "انستقرام": { "متابعين": 0.4, "لايكات": 0.1 },
        "تليجرام": { "أعضاء قناة": 0.8 }
    };

    // مراقبة حالة الدخول
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('uIDDisplay').innerText = user.uid.substring(0,8);
            loadUserData(user.uid);
            updateServices();
        } else {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }
    });

    async function loadUserData(uid) {
        db.collection("users").doc(uid).onSnapshot(doc => {
            if(doc.exists) {
                document.getElementById('uNameDisplay').innerText = doc.data().name;
                document.getElementById('uBalanceDisplay').innerText = "$" + (doc.data().balance || 0).toFixed(2);
                window.myBalance = doc.data().balance || 0;
            }
        });
    }

    // إدارة الرشق
    function updateServices() {
        const p = document.getElementById('platform').value;
        const s = document.getElementById('serviceType');
        s.innerHTML = "";
        for(let name in services[p]) {
            let opt = document.createElement('option');
            opt.value = name; opt.innerText = `${name} ($${services[p][name]} لكل 1000)`;
            s.appendChild(opt);
        }
        calcPrice();
    }

    function calcPrice() {
        const p = document.getElementById('platform').value;
        const s = document.getElementById('serviceType').value;
        const q = document.getElementById('orderQty').value || 0;
        const total = (q / 1000) * services[p][s];
        document.getElementById('totalPrice').innerText = total.toFixed(2);
    }

    async function sendOrder() {
        const cost = parseFloat(document.getElementById('totalPrice').innerText);
        if(window.myBalance < cost || cost <= 0) return alert("الرصيد غير كافٍ!");

        if(confirm(`سيتم خصم ${cost}$ من رصيدك، تأكيد؟`)) {
            const userRef = db.collection("users").doc(auth.currentUser.uid);
            await db.runTransaction(async (t) => {
                t.update(userRef, { balance: window.myBalance - cost });
                t.set(db.collection("orders").doc(), {
                    uid: auth.currentUser.uid,
                    name: document.getElementById('uNameDisplay').innerText,
                    service: document.getElementById('platform').value + " - " + document.getElementById('serviceType').value,
                    link: document.getElementById('orderLink').value,
                    qty: document.getElementById('orderQty').value,
                    status: "pending",
                    date: new Date()
                });
            });
            alert("تم إرسال الطلب بنجاح!");
        }
    }

    // إدارة الشحن
    async function submitRechargeRequest() {
        const file = document.getElementById('payFile').files[0];
        let base64 = null;
        if(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                await sendToFirebase(reader.result);
            }
        } else {
            await sendToFirebase(null);
        }
    }

    async function sendToFirebase(img) {
        await db.collection("recharges").add({
            uid: auth.currentUser.uid,
            name: document.getElementById('uNameDisplay').innerText,
            method: document.getElementById('payMethod').value,
            code: document.getElementById('payCode').value,
            amount: parseFloat(document.getElementById('payAmount').value),
            proof: img,
            status: "pending",
            date: new Date()
        });
        alert("تم إرسال طلب الشحن للمسؤول");
        closeModal('rechargeModal');
    }

    // لوحة التحكم
    function checkAdmin() {
        const myID = auth.currentUser.uid;
        // قم بتغيير رقم الـ ID بالأسفل لفتح اللوحة لك وحدك
        if(myID === "ADMIN_UID_HERE" || auth.currentUser.email === "admin@gmail.com") {
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminData();
        } else {
            alert("هذا القسم للمسؤول فقط. الـ ID الخاص بك هو: " + myID);
        }
    }

    function loadAdminData() {
        // شحن
        db.collection("recharges").where("status", "==", "pending").onSnapshot(snap => {
            const list = document.getElementById('adminRechargeList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const r = doc.data();
                list.innerHTML += `
                    <div class="admin-item">
                        <b>${r.name}</b> يطلب ${r.amount}$ عبر ${r.method}<br>
                        المعلومة: ${r.code}<br>
                        ${r.proof ? `<img src="${r.proof}" class="admin-proof" onclick="window.open(this.src)">` : ''}
                        <div class="admin-actions">
                            <button class="adm-btn" style="background:var(--success)" onclick="approveRecharge('${doc.id}', '${r.uid}', ${r.amount})">قبول</button>
                            <button class="adm-btn" style="background:var(--danger)" onclick="rejectItem('recharges','${doc.id}')">حذف</button>
                        </div>
                    </div>
                `;
            });
        });

        // رشق
        db.collection("orders").where("status", "==", "pending").onSnapshot(snap => {
            const list = document.getElementById('adminServiceList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const o = doc.data();
                list.innerHTML += `
                    <div class="admin-item">
                        <b>${o.name}</b> | ${o.service}<br>
                        الكمية: ${o.qty} | الرابط: <a href="${o.link}" target="_blank">افتح الرابط</a><br>
                        <button class="adm-btn" style="background:var(--main); width:100%; margin-top:5px;" onclick="updateItemStatus('orders','${doc.id}','completed')">تم التنفيذ</button>
                    </div>
                `;
            });
        });
    }

    async function approveRecharge(docId, uid, amt) {
        const userRef = db.collection("users").doc(uid);
        await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            const newBal = (userDoc.data().balance || 0) + amt;
            t.update(userRef, { balance: newBal });
            t.update(db.collection("recharges").doc(docId), { status: "completed" });
        });
        alert("تم شحن الحساب!");
    }

    async function updateItemStatus(col, id, stat) { await db.collection(col).doc(id).update({ status: stat }); }
    async function rejectItem(col, id) { if(confirm("حذف؟")) await db.collection(col).doc(id).delete(); }

    // وظائف مساعدة
    function toggleAuth(isSignup) {
        document.getElementById('signupBox').style.display = isSignup ? 'block' : 'none';
        document.getElementById('loginBox').style.display = isSignup ? 'none' : 'block';
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    async function handleSignup() {
        const name = document.getElementById('newName').value, email = document.getElementById('newEmail').value, pass = document.getElementById('newPass').value;
        try {
            const res = await auth.createUserWithEmailAndPassword(email, pass);
            await db.collection("users").doc(res.user.uid).set({ name, balance: 0.0, date: new Date() });
        } catch(e) { alert(e.message); }
    }
    async function handleLogin() {
        try { await auth.signInWithEmailAndPassword(document.getElementById('logEmail').value, document.getElementById('logPass').value); }
        catch(e) { alert(e.message); }
    }
</script>
</body>
</html>
